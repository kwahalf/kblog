{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"blog/","title":"Blog","text":""},{"location":"blog/tags/","title":"Tag index  for the blog","text":""},{"location":"blog/author/team/","title":"The Kwahalf Team","text":"<p>A small group of people dedicated to making learning of software engineering fundamentals easy</p>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/","title":"Demystifying The M-Pesa API (Lipa Na M-Pesa Online Payment)","text":"<p>Payment matrix</p> <p>M-Pesa is a mobile phone-based money transfer, financing and microfinancing service, launched in 2007 by Vodafone for Safaricom and Vodacom the largest mobile network operators in Kenya and Tanzania.</p> <p>M-Pesa allows users to deposit, withdraw, transfer money and pay for goods and services (Lipa na M-Pesa) easily with mobile devices. M-Pesa has spread quickly like wildfire, and by 2010 had become the most successful mobile-phone-based financial service in the world.</p> <p>With M-Pesa winning the heart and souls of the masses, there was a section of the population who yearned for more. These were the software developers, they wanted an API to access the M-Pesa products. Safaricom responded to them by giving them the M-Pesa G2 API. This was welcomed but only a handful of developers were able to integrate their apps with it. Some did not have the infrastructure nor the technical know-how to do the integrations because of its requirements which included: VPN connection, soap protocol, etc.</p> <p>Safaricom recently introduced a new M-Pesa API dubbed \u2018The Daraja API\u2019 (Daraja in Swahili means bridge) to try and bridge this gap for developers. You can access this API over the public internet a step up from the G2 API which required a VPN connection. The other change was that it communicated over the REST protocol, this was to try and alleviate the pain of the developers whose Apps use REST protocol but had to find a way to accommodate M-Pesa\u2019s SOAP. Daraja API not only had the old services from G2 API(C2B, B2C, and reversal) but also exposed new M-Pesa services(B2B, Transaction status, Account balance, and Lipa na M-Pesa online)</p> <p>In this article, we\u2019ll just cover the Lipa na M-Pesa online as this is one of the most exciting API they have provided so far.</p>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/#prerequisites","title":"Prerequisites","text":"<ol> <li> <p>You should have a Safaricom developers account. If you don\u2019t have one go here developers portal and register to get an account. It is free.</p> </li> <li> <p>I will be demonstrating the use of the API using Javascript hence you should at least have a grasp of the basics in javascript although you can follow and re-implement with the language of your choice.</p> </li> <li> <p>You should have Node installed</p> </li> <li> <p>We will be using Ngrok to expose our local server to the internet hence having it downloaded now is encouraged.</p> </li> <li> <p>We will be using Postman to send requests so downloading it encouraged.</p> </li> </ol>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/#lipa-na-m-pesa-online","title":"Lipa Na M-Pesa Online","text":"<p>The Lipa na M-Pesa online service exposed by Daraja API is a very efficient way to implement merchant checkouts in e-commerce sites, mobile Apps, car parking management systems etc.</p> <p>A common implementation is, you have a checkout button in your mobile App/ internet site which a user clicks to pay for the goods or services you are offering. This button when clicked triggers a post request to Daraja with the relevant payload. When Daraja receives the request it then triggers an STK push to the user\u2019s phone prompting the user to enter his/her M-Pesa password to complete the transaction. When the user enters the password to complete the transaction, this request is sent to M-Pesa for processing, the user\u2019s M-Pesa account is debited, and then you receive a webhook (to your servers webhook URL you provided) with the details of the transaction.</p>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/#webhook-server","title":"Webhook Server","text":"<p>We will now implement the server which will be receiving these webhooks from Safaricom. Our server will have minimal functionality and nothing fancy hence you should not move with it to your production environment.</p> <p>We will use ExpressJS a JS library to implement our simple server.</p> <p>Okay let\u2019s go to our terminal and create a new folder and call it webhook</p> <pre><code> mkdir webhook &amp;&amp; cd webhook\n</code></pre> <p>Initiate our package.json in our directory</p> <pre><code>npm init\n</code></pre> <p>Let\u2019s now install our dependencies using npm</p> <pre><code>npm i -s express body-parser prettyjson\n</code></pre> <p>we will use body-parser middleware to extract the entire body portion of an incoming request stream and exposes it on <code>req.body</code>.</p> <p>we will use <code>prettyjson</code> to format the output that we will dump in the terminal.</p> <p>Now let\u2019s implement our server, create a file called <code>server.js</code></p> <pre><code>  const prettyjson = require('prettyjson');\n  const express = require('express');\n  const bodyParser = require('body-parser')\n\n  const options = {\n    noColor: true\n  };\n\n  // create an express app and configure it with boadyParser middleware\n  const app = express();\n  app.use(bodyParser.json());\n  app.use(bodyParser.urlencoded({ extended: true }));\n\n  // create our webhook endpoint to recive webhooks from Safaricom\n  app.post('/hooks/mpesa', (req, res) =&gt; {\n    console.log('-----------Received M-Pesa webhook-----------');\n\n    // format and dump the request payload recieved from safaricom in the terminal\n    console.log(prettyjson.render(req.body, options));\n    console.log('-----------------------');\n\n    let message = {\n      \"ResponseCode\": \"00000000\",\n      \"ResponseDesc\": \"success\"\n    };\n\n    // respond to safaricom servers with a success message\n    res.json(message);\n  });\n\n  const server = app.listen(5000, () =&gt; {\n    let host = server.address().address;\n    let port = server.address().port;\n    console.log(`server listening on port ${port}` );\n  });\n</code></pre> <p>Let's start our server and test it out</p> <pre><code>node server.js\n</code></pre> <p></p> <p>Now that our server is running let's expose it to the internet using ngrok. Go to the folder where you downloaded and extracted ngrok and run</p> <p><pre><code>./ngrok http 5000\n</code></pre> </p> <p>Now that we have connected our webhook server to the internet let\u2019s test to see if we can reach it on the exposed URL. Fire up postman and send a JSON post to the link exposed on your ngrok followed by the endpoint of or webhook. for my case it will be <code>https://05135c4e.ngrok.io/hooks/mpesa</code> for you the <code>05135c4e.ngrok.io</code> will be different because every time you start ngrok it will give you a new unique URL.</p> <p></p> <p>Our request is then dumped to the terminal as expected</p> <p></p> <p>Now that we have developed our simple server and exposed it on the internet let us now interact with the M-Pesa API.</p>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/#m-pesa-app","title":"M-Pesa App","text":"<p>Go to the developers portal log in with your credentials then click on the my apps tab to access your apps. Create a new app by clicking on the Add new App button which will take you to a page like the one bellow</p> <p></p> <p>Enter your App name and check the Lipa Na Mpesa Sandbox checkbox then click the create app button.</p> <p>Click on the app you\u2019ve created to see the details and the credentials you will use to access the M-Pesa API.</p> <p></p> <p>Note</p> <p>I created this app for demonstration purposes and it was deleted after so the keys exposed are no longer functional for those of us who will be scrambling to use them.</p> <p>Now that we have the credentials let\u2019s authenticate ourselves and get a token that we will use to interact with the Lipa na M-Pesa service.</p> <p>since we have not gone Live with our app we will use the sandbox endpoints to demonstrate (<code>https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials</code>). It uses basic auth to authenticate and returns our api token that we will use to access the Lipa na M-Pesa service. The username is your customer key and the password is your customer secret. So open postman and click the authorization tab and select type as basic auth. Fill in the Username and Password then paste the link url box.</p> <p></p> <p>Then send the get request to get the token as shown bellow.</p> <p></p> <p>Now that we have the access token let\u2019s send our first request to the Lipa na M-Pesa service. This service expects a request payload that is JSON containing.:</p> <ol> <li> <p>BusinessShortCode: This is the organisation\u2019s short-code (Paybill or Buygood) used to identify an organisation and receive the transaction.</p> </li> <li> <p>Password: This is the password used for encrypting the request sent: A base64 encoded string. (The base64 string is a combination of <code>Short-code+Passkey+Timestamp</code>)</p> </li> <li> <p>Timestamp: This is the Timestamp of the transaction, normally in the formart of <code>YEAR+MONTH+DATE+HOUR+MINUTE+SECOND</code> (YYYYMMDDHHMMSS) Each part should be at-least two digits apart from the year which takes four digits.</p> </li> <li> <p>TransactionType: This is the transaction type that is used to identify the transaction when sending the request to M-Pesa. The transaction type for M-Pesa Express is \u201cCustomerPayBillOnline\u201d</p> </li> <li> <p>Amount: This is the Amount transacted normally a numeric value. Money that customer pays to the Short-code. Only whole numbers are supported.</p> </li> <li> <p>PartyA: The phone number sending money. The parameter expected is a Valid Safaricom Mobile Number that is M-Pesa registered in the format <code>2547XXXXXXXX</code></p> </li> <li> <p>PartyB: The organisation receiving the funds. The parameter expected is a 5 to 6 digit as defined on the Short-code description above. This can be the same as BusinessShortCode value above.</p> </li> <li> <p>PhoneNumber: The Mobile Number to receive the STK Pin Prompt. This number can be the same as PartyA value above. Use only Safaricom numbers.</p> </li> <li> <p>CallBackURL: A CallBack URL is a valid secure URL that is used to receive notifications from M-Pesa API. It is the endpoint to which the results will be sent by M-Pesa API.</p> </li> <li> <p>AccountReference: This is an Alpha-Numeric parameter that is defined by your system as an Identifier of the transaction for CustomerPayBillOnline transaction type. Along with the business name, this value is also displayed to the customer in the STK Pin Prompt message. Maximum of 12 characters.</p> </li> <li> <p>TransactionDesc: This is any additional information/comment that can be sent along with the request from your system. Maximum of 13 Characters</p> </li> </ol> <p>For testing we can get the testing credentials here once logged in.</p> <p>On the credentials page we will use the Lipa Na Mpesa Online Short-code as our BusinessShortCode and PartyB. We will also use Lipa Na Mpesa Online Passkey as our Passkey for generating a base64 string password.</p> <p>To generate your base64 string password go to this website and encode your</p> <p><code>Shortcode+Passkey+Timestamp</code> (eg 174379bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c91920181015123520) then copy the base64 encoded string to use it as your password.</p> <p>We will then send a post request containing the payload described above and with an Authorization header containing:</p> <p><code>Bearer &lt;Access-Token&gt;</code> to this URL <code>https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest</code></p> <p>So open postman and click the authorization tab and select type as Bearer token. Fill in the token (The API token we got from our authorization request)then paste the link url box.</p> <p></p> <p>Select the type of request to be a <code>post</code> request then click on the body tab, click on the raw payload, select the content type as <code>application/json</code> and enter the JSON payload and click send.</p> <p></p> <p>The phone-number provided would then receive a STK push to enter the M-Pesa pin to complete the transaction.</p> <p></p> <p>After the pin is entered the customer is debited then M-Pesa sends a webhook payload to the URL we provided.</p> <p></p> <p></p> <p>All the deducted funds during testing are automatically reversed to your account later by Safaricom.</p>"},{"location":"blog/2018/10/15/demystifying-the-m-pesa-api/#conclusion","title":"Conclusion","text":"<p>With this introduction you can continue to play around in the sandbox and explore this API. I hope the article was informative to you. You could leave comments on which M-Pesa API service you would like me to write an article on next. Until next time bye.</p> <p>Share on  Share on </p>"},{"location":"blog/archive/2018/","title":"October 2018","text":""},{"location":"blog/category/payment-integrations/","title":"Payment Integrations","text":""}]}